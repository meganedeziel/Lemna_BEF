---
title: "LEMMNA BEF: CALCULATE BEF THROUGH TIME"
author: "meganedeziel"
date: "2023-09-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### package loading
```{r, messages = FALSE}
library(here)
library(tidyverse)
library(nlme)
library(emmeans)
library(ggpubr)
library(grid)
```
The generic lme() function allows to specify and fit models with nested random effects and correlated and/or heteroscedastic within-group residual errors.
### data importation
```{r}
#Total biomass through time 
Biomass_data<-read.csv(here("data", "Biomass_data.csv"), sep=";")

#Relative biomass through time 
Relbiomass_data<-read.csv(here("data", "Relativebiomass_data.csv"), sep=";")

#Net effect, CE, SE 
NE_data<-read.csv(here("data", "NE_data.csv"), sep=";")
str(NE_data)

NE_data<-NE_data[, -1]
NE_data<-NE_data %>%
  mutate(across(c("Composition", "Block", "Days"), 
                as.factor)) #transform Composition, Block, Days as factor

# Plot Raw data - NE against Days
PlotNE <- ggplot(NE_data, aes(x = Days, y = NE)) + 
  geom_jitter(position=position_jitter(0.2)) + 
  stat_summary(fun.data="mean_sdl",  fun.args = list(mult=1), 
               geom="pointrange", color = "red")+
  theme_classic() +
  labs(x="Days", y="NE") 

PlotCE <- ggplot(NE_data, aes(x = Days, y = CE)) + 
  geom_jitter(position=position_jitter(0.2)) + 
  stat_summary(fun.data="mean_sdl",  fun.args = list(mult=1), 
               geom="pointrange", color = "red")+
  theme_classic() +
  labs(x="Days", y="NE")

PlotSE <- ggplot(NE_data, aes(x = Days, y = SE)) + 
  geom_jitter(position=position_jitter(0.2)) + 
  stat_summary(fun.data="mean_sdl",  fun.args = list(mult=1), 
               geom="pointrange", color = "red")+
  theme_classic() +
  labs(x="Days", y="NE")

#mean_sdl computes the mean plus or minus a constant times the standard deviation 
#(here the constant (mult) =1), so we see mean + standard deviation in Red
#We can clearly see that the variance of NE increases over time 
```

Since the variance of NE increases over time, we decided to use the function nlme::lme to make our ANOVAs, because the function allows to weight the variance by days. 

The class pdMat, which represent positive-definite matrices, is used to represent variance-covariance matrices of random effects. 
We have have two blocks in the random effects variance-covariance matrix: one for Composition, and one for Block
Source: https://stackoverflow.com/questions/36643713/how-to-specify-different-random-effects-in-nlme-vs-lme4

Our model also needs to account for different residual variances for different levels of our factor Days. The varIdent function allows different variances according to the levels of a classification factor. 

### ANOVA 1 : net effect through time
```{r}
# Model testing the effect of Jours on NE with Composition and Bloc as random factors and weighted by Jours.

# Here we add a dummy factor just to include the whole dataset in a single block. 
NE_data$dummy<-factor(1)

modNE <- lme(NE ~ Days,
              random=list(dummy=pdBlocked(list(pdIdent(~Composition-1), 
                                               pdIdent(~Block-1)))),
              data=NE_data,
              weights=varIdent(form=~ 1 | Days),
              method="REML", 
              control=list(msMaxIter=1000,
                             msMaxEval=1000))

anova(modNE)
summary(modNE)

# Post-Hoc analysis - Tukey

#The most common follow-up analysis for models having factors as predictors is to compare the EMMs with one another
#This may be done simply via the pairs() method for emmGrid objects
#pairs() sets two defaults for summary(): adjust="tuckey" (multiplicity adjustment), and infer=c(FALSE, TRUE) (test statisticts, not confidence intervals). 
contrast <- emmeans(modNE, "Days")
pairs(contrast)


# Model validation
par(mfrow=c(1,2))
plot(fitted(modNE), resid(modNE,type="pearson"))
qqnorm(resid(modNE,type="pearson"))
qqline(resid(modNE,type="pearson"))

##PLOT
# I use the Tofino color palette from hcl.colors
hcl.colors(4, palette="Fall")

NE_meanse<-data.frame(
  days=c("0", "20", "40", "60"),
  mean=as.vector(summary(modNE)$tTable[,1]),
  se=as.vector(summary(modNE)$tTable[,2]),
  label=c("a", "b", "c", "c"))
NE_meanse$ci<-NE_meanse$se*1.96

NEp<-ggplot(NE_meanse) +
  geom_bar(aes(x=days, y=mean), colour="black", fill="#3C5941", stat="identity", alpha=0.7) +
  #geom_errorbar(aes(x=days, ymin=mean-se, ymax=mean+se), width=0.4, colour="red", alpha=0.9, size=1.3) +
  geom_errorbar(aes(x=days, ymin=mean-ci, ymax=mean+ci), width=0.4, colour="black", alpha=0.9, size=1.3) +
  geom_text(aes(x=days, y=mean+ci+100, label=label,), position=position_dodge(0.9), vjust=1, size=7) +
  theme_classic() + 
  theme(text=element_text(size=15), plot.title=element_text(vjust=2), panel.grid.major.y = element_line( size=.1, color="black" )) +
  labs(x="Days of growth", y="NE", title="Net biodiversity effect", pch=8) +
  scale_y_continuous(limits=c(0, 1000), breaks=seq(0, 1000, by=200)) 
```
### ANOVA 2 : complementarity effect through time
```{r}
modCE <- lme(CE ~ Days,
              random=list(dummy=pdBlocked(list(pdIdent(~Composition-1), 
                                               pdIdent(~Block-1)))),
              data=NE_data,
              weights=varIdent(form=~ 1 | Days),
              method="REML", 
              control=list(msMaxIter=1000,
                             msMaxEval=1000))

anova(modCE)
summary(modCE)
contrastCE <- emmeans(modCE, "Days")
pairs(contrastCE)

par(mfrow=c(1,2))
plot(fitted(modCE), resid(modCE,type="pearson"))
qqnorm(resid(modCE,type="pearson"))
qqline(resid(modCE,type="pearson"))

### PLOT
CE_meanse<-data.frame(
  days=c("0", "20", "40", "60"),
  mean=as.vector(summary(modCE)$tTable[,1]),
  se=as.vector(summary(modCE)$tTable[,2]),
  label=c("a", "b", "bc", "c"))
CE_meanse$ci<-CE_meanse$se*1.96

CEp<-ggplot(CE_meanse) +
  geom_bar(aes(x=days, y=mean), colour="black", fill="#3C5941", stat="identity", alpha=0.7) +
  #geom_errorbar(aes(x=days, ymin=mean-se, ymax=mean+se), width=0.4, colour="red", alpha=0.9, size=1.3) +
  geom_errorbar(aes(x=days, ymin=mean-ci, ymax=mean+ci), width=0.4, colour="black", alpha=0.9, size=1.3) +
  geom_text(aes(x=days, y=mean+ci+100, label=label,), position=position_dodge(0.9), vjust=1, size=7) +
  theme_classic() + 
  theme(text=element_text(size=15), plot.title=element_text(vjust=2), panel.grid.major.y = element_line( size=.1, color="black" )) +
  labs(x="Days of growth", y="CE", title="Complementarity effect", pch=8) +
  scale_y_continuous(limits=c(0, 1000), breaks=seq(0, 1000, by=200)) 
```
### ANOVA 3 : Selection effect through time
```{r}
modSE <- lme(SE ~ Days,
              random=list(dummy=pdBlocked(list(pdIdent(~Composition-1), 
                                               pdIdent(~Block-1)))),
              data=NE_data,
              weights=varIdent(form=~ 1 | Days),
              method="REML", 
              control=list(msMaxIter=1000,
                             msMaxEval=1000))

anova(modSE)
summary(modSE)
contrastSE <- emmeans(modSE, "Days")
pairs(contrastSE)

par(mfrow=c(1,2))
plot(fitted(modSE), resid(modSE,type="pearson"))
qqnorm(resid(modSE,type="pearson"))
qqline(resid(modSE,type="pearson"))

### PLOT
SE_meanse<-data.frame(
  days=c("0", "20", "40", "60"),
  mean=as.vector(summary(modSE)$tTable[,1]),
  se=as.vector(summary(modSE)$tTable[,2]),
  label=c("a", "a", "b", "a"))
SE_meanse$ci<-SE_meanse$se*1.96

SEp<-ggplot(SE_meanse) +
  geom_bar(aes(x=days, y=mean), colour="black", fill="#3C5941", stat="identity", alpha=0.7) +
  #geom_errorbar(aes(x=days, ymin=mean-se, ymax=mean+se), width=0.4, colour="red", alpha=0.9, size=1.3) +
  geom_errorbar(aes(x=days, ymin=mean-ci, ymax=mean+ci), width=0.4, colour="black", alpha=0.9, size=1.3) +
  geom_text(aes(x=days, y=mean+ci+100, label=label,), position=position_dodge(0.9), vjust=1, size=7) +
  theme_classic() + 
  theme(text=element_text(size=15), plot.title=element_text(vjust=2), panel.grid.major.y = element_line( size=.1, color="black" )) +
  labs(x="Days of growth", y="SE", title="Selection effect", pch=8) +
  scale_y_continuous(limits=c(-400, 600)) 
```

###Final plots BEF through time
```{r}
BEFplots<-ggarrange(NEp, CEp, SEp, nrow=1, ncol=3, common.legend = TRUE) 
BEFplots
#annotate_figure(BEFplots, bottom = textGrob("Days of growth", rot = 90, vjust = 1, gp = gpar(cex = 1.3)))
```
